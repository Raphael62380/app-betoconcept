<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur B√©toconcept V36 (Lisibilit√© & Fit)</title>
    
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzI3YWU2MCIgcng9IjIwIi8+PHBhdGggZD0iTTIwIDcwIEwyMCAzMCBMODAgMzAgTDgwIDcwIFoiIGZpbGw9IndoaXRlIi8+PHJlY3QgeD0iMzAiIHk9IjQwIiB3aWR0aD0iNDAiIGhlaWdodD0iMjAiIGZpbGw9IiMyN2FlNjAiLz48L3N2Zz4=">

    <style>
        :root {
            --primary: #27ae60;
            --secondary: #2c3e50;
            --accent: #e67e22;
            --info: #2980b9;
            --buried: #8d6e63;
            --bg: #f0f2f5;
            --panel: #ffffff;
        }
        
        /* LAYOUT GLOBAL : Emp√™cher le scroll global si possible */
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: var(--secondary); 
            font-size: 13px; 
            height: 100vh; /* Hauteur fixe √©cran */
            overflow: hidden; /* On g√®re le scroll dans les panneaux */
        }

        .app-grid { 
            display: grid; 
            grid-template-columns: 380px 1fr 320px; /* Colonnes un peu ajust√©es */
            gap: 15px; 
            padding: 10px; 
            box-sizing: border-box; 
            height: 100vh;
        }

        .panel { 
            background: var(--panel); 
            border-radius: 8px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            overflow-y: auto; /* Scroll uniquement DANS les panneaux */
            height: 100%; 
            box-sizing: border-box;
        }
        
        /* HEADER */
        .app-header { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; background: #fafafa; border-radius: 6px; padding-top: 5px; }
        #logo-img { height: 50px; width: auto; margin-right: 10px; object-fit: contain; }
        .app-title h1 { margin: 0; font-size: 1.2em; color: var(--secondary); font-weight: 800; text-transform: uppercase; }
        .app-title span { font-size: 0.8em; color: var(--primary); font-weight: 600; }

        h2 { font-size: 1em; border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin: 0 0 10px 0; color: var(--primary); text-transform: uppercase; }
        h3 { font-size: 0.9em; color: #7f8c8d; margin: 10px 0 5px 0; font-weight: 600; text-transform: uppercase; border-top: 1px solid #eee; padding-top: 8px; }
        
        .form-group { margin-bottom: 8px; }
        label { display: block; margin-bottom: 3px; font-weight: 600; font-size: 0.85em; }
        input, select { width: 100%; padding: 5px; border: 1px solid #bdc3c7; border-radius: 4px; box-sizing: border-box; font-size: 0.95em; }
        
        .btn-group { display: flex; border: 1px solid #bdc3c7; border-radius: 4px; overflow: hidden; margin-bottom: 10px; flex-shrink: 0; }
        .btn-mode { flex: 1; padding: 6px; border: none; background: #f8f9fa; cursor: pointer; font-weight: 600; font-size: 0.8em; }
        .btn-mode.active { background: var(--secondary); color: white; }
        
        .color-switch { display: flex; gap: 10px; margin-bottom: 8px; background: #f8f9fa; padding: 4px; border-radius: 4px; }
        .radio-label { flex: 1; text-align: center; cursor: pointer; padding: 4px; border-radius: 4px; font-size: 0.85em; }
        .radio-label.checked { background: var(--accent); color: white; font-weight: bold; }
        
        .shape-switch { display: flex; gap: 5px; margin-bottom: 10px; background: #e8f5e9; padding: 4px; border-radius: 4px; }
        .shape-btn { flex: 1; border: 1px solid var(--primary); color: var(--primary); background: white; padding: 4px; border-radius: 4px; cursor: pointer; text-align: center; font-weight: bold; font-size: 0.85em; }
        .shape-btn.active { background: var(--primary); color: white; }

        .nappe-list { border: 1px solid #eee; background: #fafafa; border-radius: 4px; padding: 5px; overflow-y: visible; margin-bottom: 15px; }
        .nappe-row { display: grid; grid-template-columns: 70px 80px 1fr; align-items: center; gap: 5px; padding: 3px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .nappe-row.buried-row { background: #efebe9; border-left: 3px solid var(--buried); }
        .depth-select { padding: 2px; font-size: 0.85em; }
        .nappe-input { text-align: right; padding: 2px; }
        
        /* Visu Container : Prend tout l'espace restant, pas de scroll, centr√© */
        #visu-container { 
            flex-grow: 1; 
            border: 1px dashed #bdc3c7; 
            border-radius: 4px; 
            background: white; 
            position: relative; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        
        .res-block { background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid var(--secondary); font-size: 0.9em; }
        .res-block.logistique { background: #eaf2f8; border-left-color: var(--info); }
        .res-line { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .res-total { font-size: 1.1em; font-weight: bold; color: var(--primary); text-align: right; margin-top: 5px; border-top: 1px solid #ddd; padding-top: 5px; }
        .price-input { width: 60px; text-align: right; padding: 2px 5px; }
        .height-proposal { font-size: 0.8em; color: var(--info); background: #eaf2f8; padding: 3px; border-radius: 4px; margin-top: 3px; border-left: 3px solid var(--info); }
        .remise-input { width: 40px !important; text-align: center; border: 1px solid var(--accent) !important; color: var(--accent); font-weight: bold; }

        /* IMPRESSION */
        @media print {
            body { height: auto; overflow: visible; font-size: 11px; background: white; }
            .app-grid { display: block; padding: 0; height: auto; }
            .panel { margin-bottom: 15px; box-shadow: none; border: 1px solid #ddd; height: auto; overflow: visible; page-break-inside: avoid; }
            .btn-group, .no-print { display: none; }
            input, select { border: none; background: transparent; padding: 0; appearance: none; }
            #visu-container { height: 600px; border: 1px solid #000; page-break-inside: avoid; }
            .res-block.logistique { background: #fff; border: 1px solid #ccc; }
            .remise-input { border: 1px solid #ccc !important; }
        }
        @media (max-width: 1000px) { 
            body { overflow: auto; height: auto; } 
            .app-grid { display: block; height: auto; } 
            .panel { margin-bottom: 20px; height: auto; } 
            #visu-container { height: 400px; }
        }
    </style>
</head>
<body>

<div class="app-grid">
    <div class="panel">
        <div class="app-header">
            <img id="logo-img" src="logo.png" alt="B√©toconcept" onerror="this.style.display='none'">
            <div class="app-title"><h1>B√©toconcept</h1><span>Calculateur V36</span></div>
        </div>

        <div class="btn-group">
            <button class="btn-mode active" onclick="setTarif('negoce', this)">N√©goce</button>
            <button class="btn-mode" onclick="setTarif('entreprise', this)">Entreprise</button>
            <button class="btn-mode" onclick="setTarif('particulier', this)">Particulier</button>
        </div>

        <div class="form-group"><label>Affaire / Client</label><input type="text" id="client"></div>

        <div class="shape-switch">
            <div class="shape-btn active" id="btn-rect" onclick="setShape('rect')">Mur Droit</div>
            <div class="shape-btn" id="btn-trap" onclick="setShape('trap')">Mur Trap√®ze</div>
        </div>

        <div class="form-group">
            <label>Produit</label>
            <select id="produit" onchange="updateUI()">
                <option value="leromur">LEROMUR (H=13cm)</option>
                <option value="betoatlas">BETOATLAS (H=20cm)</option>
            </select>
        </div>

        <div class="form-group" style="display:flex; gap:5px;">
            <div style="flex:1;"><label>Fruit (¬∞)</label><input type="number" id="inclinaison" value="0" min="0" max="45" oninput="calculer()"></div>
            <div style="flex:1;"><label>Long. (m)</label><input type="number" id="longueur" value="10" oninput="calculer()"></div>
        </div>

        <h3>Fondation & Hors-Gel</h3>
        <div class="form-group" style="display:flex; gap:5px; background:#efebe9; padding:5px; border-radius:4px;">
            <div style="flex:1"><label style="color:#5d4037;">Hors Gel (cm)</label><input type="number" id="hors-gel" value="80" onchange="genererNappes()" style="border-color:#8d6e63;"></div>
            <div style="flex:1"><label style="color:#5d4037;">Semelle (cm)</label><input type="number" id="h-fondation" value="30" onchange="genererNappes()" style="border-color:#8d6e63;"></div>
        </div>
        <div id="hors-gel-info" style="font-size:0.8em; color:var(--buried); margin-bottom:5px; font-style:italic;"></div>

        <div class="color-switch">
            <label class="radio-label checked" onclick="setColor('gris', this)"><input type="radio" name="color" checked> Gris</label>
            <label class="radio-label" onclick="setColor('couleur', this)"><input type="radio" name="color"> Couleur</label>
        </div>

        <div class="form-group" style="display:flex; gap:5px; align-items:flex-start;">
            <div style="flex:1">
                <label id="lbl-h-gauche">H. Visible</label>
                <input type="number" id="hauteur" value="2.00" min="0" step="0.01" onchange="genererNappes()">
                <div id="proposal-gauche" class="height-proposal" style="display:none"></div>
            </div>
            <div style="flex:1; display:none;" id="col-h-droite">
                <label>H. Droite</label>
                <input type="number" id="hauteur-droite" value="1.00" min="0" step="0.01" onchange="genererNappes()">
                <div id="proposal-droite" class="height-proposal" style="display:none"></div>
            </div>
        </div>

        <h3>Coupe de Principe</h3>
        <div style="font-size:0.8em; color:#666; display:flex; justify-content:space-between; padding:0 5px;"><span>Rang</span><span id="col-depth-title">Prof.</span><span>Nappe</span></div>
        <div id="nappes-container" class="nappe-list"></div>
        <div class="form-group">
            <label>G√©otextile</label>
            <select id="typeGeo" onchange="updatePrixGeo()">
                <option value="50">B√©tonap 50/50</option>
                <option value="100" selected>B√©tonap 100/50</option>
                <option value="150">B√©tonap 150/50</option>
                <option value="200">B√©tonap 200/50</option>
            </select>
        </div>
    </div>

    <div class="panel">
        <h2>2. Vue de Face & Coupe</h2>
        <div id="visu-container"></div>
        <div style="text-align:center; font-size:0.8em; color:#999; margin-top:5px;">
            Echelle R√©elle (1:1) ‚Ä¢ <span style="color:var(--buried);">Marron</span>=Enterr√© ‚Ä¢ <span style="color:gray;">Gris</span>=Fondation
        </div>
    </div>

    <div class="panel">
        <h2>3. Chiffrage</h2>
        <div class="res-block">
            <div class="res-line"><span>Surf. Visible:</span> <strong id="res-surf">0.00 m¬≤</strong></div>
            <div class="res-line"><span>Surf. Enterr√©e:</span> <strong id="res-surf-buried" style="color:var(--buried)">0.00 m¬≤</strong></div>
            <div class="res-line"><span id="lbl-qty">Quantit√©:</span> <strong id="res-qty">0</strong></div>
        </div>
        <div class="res-block logistique">
            <div style="font-weight:bold; color:var(--info); font-size:0.9em;">üì¶ Logistique</div>
            <div class="res-line" style="justify-content:flex-end; font-weight:bold;"><span id="log-detail-palettes">0 pal</span></div>
            <div class="log-full-pallet">
                <div>Option Pal. Compl√®tes:</div>
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span id="log-pal-sup">0 Pal</span><span id="log-items-sup">0 u</span>
                </div>
            </div>
            <div class="log-full-pallet">
                <div>G√©otextile (L=5.30m):</div>
                <div class="res-line"><span>M√©tr√©:</span> <strong id="log-ml">0 ml</strong></div>
                <div style="text-align:right; font-weight:bold; font-size:0.9em;" id="log-detail-rouleaux"></div>
            </div>
        </div>
        <div class="form-group"><label>√âtude (‚Ç¨ HT)</label><input type="number" id="cout-etude" value="0" oninput="calculer()"></div>
        <div class="res-line"><span>P.U. Bloc:</span> <input class="price-input" id="pu-bloc" type="number" step="0.01" onchange="calculer()"> ‚Ç¨</div>
        <div class="res-line"><span>P.U. G√©o:</span> <input class="price-input" id="pu-geo" type="number" step="0.01" onchange="calculer()"> ‚Ç¨</div>
        <hr>
        <div class="res-line" style="color:var(--accent);"><span style="font-weight:bold;">Remise Bloc:</span><span><input type="number" id="remise-bloc" class="remise-input" value="0" min="0" max="100" oninput="calculer()"> %</span></div>
        <div class="res-line" style="color:var(--accent);"><span style="font-weight:bold;">Remise G√©o:</span><span><input type="number" id="remise-geo" class="remise-input" value="0" min="0" max="100" oninput="calculer()"> %</span></div>
        <hr>
        <div class="res-line"><span>Total Blocs:</span> <span id="tot-blocs">0.00 ‚Ç¨</span></div>
        <div class="res-line"><span>Total G√©o:</span> <span id="tot-geo">0.00 ‚Ç¨</span></div>
        <div class="res-total">NET HT : <span id="grand-total">0.00 ‚Ç¨</span></div>
        <div style="text-align:right; font-size:0.85em; color:var(--primary);">Soit <strong id="px-m2">0.00</strong> ‚Ç¨ HT / m¬≤</div>
        <button class="no-print" onclick="window.print()" style="margin-top:auto; background:var(--primary); color:white; border:none; padding:10px; border-radius:4px; font-weight:bold; cursor:pointer;">IMPRIMER</button>
    </div>
</div>

<script>
    const CONSTANTS = { LEROMUR_BLOCS_M2: 38.5, LEROMUR_H: 0.13, BETOATLAS_H: 0.20, BETOATLAS_BLOCS_M2: 20, RECOUVREMENT: 0.40, RECOUVREMENT_LATERAL: 0.20, PALETTE_LERO: 24, PALETTE_BETO: 48, LARGEUR_ROULEAU: 5.30, LONGUEUR_ROULEAU: 100 };
    const DATA = { leromur: { h: CONSTANTS.LEROMUR_H, prices: { gris: [5.98, 6.70, 7.24], couleur: [7.37, 8.25, 8.91] } }, betoatlas: { h: CONSTANTS.BETOATLAS_H, prices: { gris: [3.99, 4.47, 4.83], couleur: [4.63, 5.19, 5.61] } } };
    const GEO_PRICES = { "50": [3.88, 4.35, 4.70], "100": [4.68, 5.24, 5.66], "150": [5.53, 6.19, 6.69], "200": [6.57, 7.36, 7.95] };
    let state = { mode: 0, color: 'gris', product: 'leromur', shape: 'rect' };

    function setTarif(type, btn) { const map={'negoce':0,'entreprise':1,'particulier':2}; state.mode=map[type]; document.querySelectorAll('.btn-mode').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); refreshPrices(); calculer(); }
    function setColor(col, lbl) { state.color=col; document.querySelectorAll('.radio-label').forEach(l=>l.classList.remove('checked')); lbl.classList.add('checked'); refreshPrices(); calculer(); }
    function setShape(shape) { state.shape=shape; document.getElementById('btn-rect').className=(shape==='rect'?'shape-btn active':'shape-btn'); document.getElementById('btn-trap').className=(shape==='trap'?'shape-btn active':'shape-btn'); updateUI(); }
    function updateUI() {
        state.product=document.getElementById('produit').value; 
        document.getElementById('lbl-qty').innerText=(state.product==='leromur')?'Total Barres:':'Total Blocs:';
        document.getElementById('col-depth-title').style.visibility=(state.product==='leromur')?'visible':'hidden';
        if(state.shape==='trap') { document.getElementById('col-h-droite').style.display='block'; document.getElementById('lbl-h-gauche').innerText='H. Gauche'; } 
        else { document.getElementById('col-h-droite').style.display='none'; document.getElementById('lbl-h-gauche').innerText='H. Visible'; }
        genererNappes();
    }
    function refreshPrices() { document.getElementById('pu-bloc').value=DATA[state.product].prices[state.color][state.mode].toFixed(2); updatePrixGeo(); }
    function updatePrixGeo() { document.getElementById('pu-geo').value=GEO_PRICES[document.getElementById('typeGeo').value][state.mode].toFixed(2); calculer(); }
    
    function getBuriedHeight() {
        const hg = parseFloat(document.getElementById('hors-gel').value)||0; const hf = parseFloat(document.getElementById('h-fondation').value)||0;
        const buried = Math.max(0, (hg-hf)/100); const hElem = DATA[state.product].h;
        const nb = Math.ceil(buried/hElem); const real = nb*hElem;
        document.getElementById('hors-gel-info').innerHTML=`Enterr√©: <strong>${real.toFixed(2)}m</strong> (${nb} rg)`;
        return real;
    }

    function updateHeightProposal(id, hIn, hElem, hBur) {
        const div = document.getElementById(id); if(!hIn||hIn<=0){div.style.display='none';return;}
        const nbVis = Math.ceil((hIn+hBur)/hElem) - Math.ceil(hBur/hElem);
        div.style.display='block'; div.innerHTML=`R√©el: <strong>${(nbVis*hElem).toFixed(2)}m</strong> (${nbVis} rg)`;
    }

    function genererNappes() {
        const hVis = parseFloat(document.getElementById('hauteur').value)||0; const hElem = DATA[state.product].h; const hBur = getBuriedHeight();
        updateHeightProposal('proposal-gauche', hVis, hElem, hBur);
        let maxH = hVis;
        if(state.shape==='trap') { const hD = parseFloat(document.getElementById('hauteur-droite').value)||0; updateHeightProposal('proposal-droite', hD, hElem, hBur); maxH=Math.max(hVis, hD); } 
        else { document.getElementById('proposal-droite').style.display='none'; }
        
        const nbRangs = (maxH+hBur > 0) ? Math.ceil((maxH+hBur)/hElem) : 0;
        const container = document.getElementById('nappes-container');
        const oldRows = Array.from(container.querySelectorAll('.nappe-row')); container.innerHTML='';
        
        for(let i=0; i<nbRangs; i++) {
            const isBuried = ((i+1)*hElem <= (hBur+0.05));
            const div = document.createElement('div'); div.className = isBuried ? 'nappe-row buried-row' : 'nappe-row';
            let oldGeo=0, oldDepth="50";
            if(i<oldRows.length) { 
                const inp=oldRows[i].querySelector('.inp-nappe'); if(inp) oldGeo=inp.value;
                const ds=oldRows[i].querySelector('.depth-select'); if(ds) oldDepth=ds.value;
            }
            let selHTML = (state.product==='leromur') ? `<select class="depth-select" onchange="calculer()"><option value="25" ${oldDepth=="25"?'selected':''}>25</option><option value="50" ${oldDepth=="50"?'selected':''}>50</option><option value="75" ${oldDepth=="75"?'selected':''}>75</option><option value="100" ${oldDepth=="100"?'selected':''}>100</option></select>` : `<span style="color:#ccc; font-size:0.8em">Std</span>`;
            div.innerHTML=`<label>R${i+1} ${isBuried?'<small>(Ent)</small>':''}</label>${selHTML}<input type="number" class="nappe-input" step="0.5" placeholder="0" value="${oldGeo>0?oldGeo:''}" oninput="calculer()">`;
            container.appendChild(div);
        }
        refreshPrices();
    }

    function calculer() {
        const L = parseFloat(document.getElementById('longueur').value)||0; const hElem=DATA[state.product].h;
        const hG_in = parseFloat(document.getElementById('hauteur').value)||0; const hBur=getBuriedHeight();
        const rows = Array.from(document.querySelectorAll('.nappe-row'));
        if(rows.length===0 && hG_in>0) return;

        const profile = rows.map(r=>{
            let d=50; if(state.product==='leromur'){const s=r.querySelector('.depth-select'); if(s) d=parseInt(s.value);}
            const i=r.querySelector('.nappe-input'); return {depth:d, geo: i?parseFloat(i.value)||0:0};
        });

        const nbBur = Math.ceil(hBur/hElem);
        const hG_real = (Math.ceil((hG_in+hBur)/hElem) - nbBur)*hElem;
        
        let qty=0, sVis=0, sBur=0, geoTot=0;
        
        if(state.shape==='rect') {
            const surfTot = L*(rows.length*hElem); sBur=L*hBur; sVis=Math.max(0, surfTot-sBur);
            profile.forEach(p=>{
                if(state.product==='leromur') {
                    let div=1; if(p.depth===25) div=4; else if(p.depth===50) div=2;
                    qty += (L*CONSTANTS.LEROMUR_H*CONSTANTS.LEROMUR_BLOCS_M2)/div;
                } else qty += (L*CONSTANTS.BETOATLAS_H*CONSTANTS.BETOATLAS_BLOCS_M2);
                if(p.geo>0) geoTot += (p.geo+CONSTANTS.RECOUVREMENT)*L;
            });
        } else {
            const hD_in = parseFloat(document.getElementById('hauteur-droite').value)||0;
            const hD_real = (Math.ceil((hD_in+hBur)/hElem) - nbBur)*hElem;
            const step=0.1, steps=Math.ceil(L/step);
            const hG_tot=hG_real+hBur, hD_tot=hD_real+hBur;
            
            for(let i=0; i<steps; i++) {
                const x=(i*step)+step/2; const hLoc = hG_tot + (hD_tot-hG_tot)*(x/L);
                const nbLoc = Math.ceil(hLoc/hElem);
                const surfLoc = step*nbLoc*hElem; const burLoc = step*hBur;
                sBur+=burLoc; sVis+=Math.max(0, surfLoc-burLoc);
                const startIdx = rows.length - nbLoc;
                for(let r=0; r<nbLoc; r++) {
                    const p = profile[r]; if(p) {
                        if(state.product==='leromur') {
                            let div=1; if(p.depth===25) div=4; else if(p.depth===50) div=2;
                            qty += (step*CONSTANTS.LEROMUR_H*CONSTANTS.LEROMUR_BLOCS_M2)/div;
                        } else qty += (step*CONSTANTS.BETOATLAS_H*CONSTANTS.BETOATLAS_BLOCS_M2);
                        if(p.geo>0) geoTot += (p.geo+CONSTANTS.RECOUVREMENT)*step;
                    }
                }
            }
        }

        const geoReel = geoTot * (CONSTANTS.LARGEUR_ROULEAU/(CONSTANTS.LARGEUR_ROULEAU-2*CONSTANTS.RECOUVREMENT_LATERAL));
        const qAchat = Math.ceil(qty);
        const colis = (state.product==='leromur')?CONSTANTS.PALETTE_LERO:CONSTANTS.PALETTE_BETO;
        const nbPal = qAchat/colis; const palFull=Math.floor(nbPal); const rest=qAchat%colis;
        const nbRlx = Math.floor(Math.ceil(geoReel/CONSTANTS.LARGEUR_ROULEAU)/100);
        
        let totB = qAchat * parseFloat(document.getElementById('pu-bloc').value||0);
        let totG = geoReel * parseFloat(document.getElementById('pu-geo').value||0);
        totB *= (1-(parseFloat(document.getElementById('remise-bloc').value||0)/100));
        totG *= (1-(parseFloat(document.getElementById('remise-geo').value||0)/100));
        const total = totB + totG + parseFloat(document.getElementById('cout-etude').value||0);

        document.getElementById('res-surf').innerText=sVis.toFixed(2)+" m¬≤";
        document.getElementById('res-surf-buried').innerText=sBur.toFixed(2)+" m¬≤";
        document.getElementById('res-qty').innerText=qAchat;
        document.getElementById('log-detail-palettes').innerText=`${palFull} pal + ${rest} u`;
        document.getElementById('log-pal-sup').innerText=Math.ceil(qAchat/colis);
        document.getElementById('log-items-sup').innerText=Math.ceil(qAchat/colis)*colis;
        document.getElementById('log-ml').innerText=Math.ceil(geoReel/CONSTANTS.LARGEUR_ROULEAU)+" ml";
        document.getElementById('log-detail-rouleaux').innerText = nbRlx>0 ? `${nbRlx} rlx + coupe` : "1 rlx (coupe)";
        
        document.getElementById('tot-blocs').innerText=totB.toFixed(2)+" ‚Ç¨";
        document.getElementById('tot-geo').innerText=totG.toFixed(2)+" ‚Ç¨";
        document.getElementById('grand-total').innerText=total.toFixed(2)+" ‚Ç¨";
        document.getElementById('px-m2').innerText=(sVis>0 ? total/sVis : 0).toFixed(2);

        if(rows.length>0) draw(rows.length, hElem, profile, hBur);
    }

    function draw(nbRangs, hBloc, profile, hBuried) {
        const container = document.getElementById('visu-container');
        const hG = parseFloat(document.getElementById('hauteur').value)||0;
        const hD = (state.shape==='trap')?(parseFloat(document.getElementById('hauteur-droite').value)||0):hG;
        const L = parseFloat(document.getElementById('longueur').value)||10;
        const hFond = parseFloat(document.getElementById('h-fondation').value)||0; const hFondM=hFond/100;
        const ang = (parseFloat(document.getElementById('inclinaison').value)||0) * (Math.PI/180);

        const nbBur = Math.ceil(hBuried/hBloc);
        const hG_real = (Math.ceil((hG+hBuried)/hBloc)-nbBur)*hBloc;
        const hD_real = (Math.ceil((hD+hBuried)/hBloc)-nbBur)*hBloc;

        // VUE FACE
        const scaleFace = 90 / Math.max(hG_real+hBuried, hD_real+hBuried, 1);
        const yTopG = 100 - ((hG_real+hBuried)*scaleFace);
        const yTopD = 100 - ((hD_real+hBuried)*scaleFace);
        const ySol = 100 - (hBuried*scaleFace);
        
        let svgFace = `<svg width="100%" height="15%" viewBox="-10 -10 120 120" preserveAspectRatio="xMidYMid meet">
            <text x="50" y="0" text-anchor="middle" font-size="10" fill="#666" font-weight="bold">VUE FACE</text>
            <polygon points="0,100 100,100 100,${yTopD} 0,${yTopG}" fill="#bdc3c7" stroke="#2c3e50" stroke-width="1"/>
            <polygon points="-5,105 105,105 105,${ySol} -5,${ySol}" fill="#8d6e63" opacity="0.3"/>
            <line x1="-5" y1="${ySol}" x2="105" y2="${ySol}" stroke="#8d6e63" stroke-width="1" stroke-dasharray="3,3"/>
            <text x="-8" y="${yTopG+5}" font-size="10">${hG_real.toFixed(2)}m</text>
            <text x="102" y="${yTopD+5}" font-size="10">${hD_real.toFixed(2)}m</text>
            <text x="50" y="115" font-size="10" text-anchor="middle">L=${L}m</text>
        </svg>`;

        // COUPE TECHNIQUE
        // 1m = 30px pour que √ßa rentre
        const S = 30; 
        const maxGeo = Math.max(1, ...profile.map(p=>p.geo));
        const totH = nbRangs*hBloc;
        const shift = totH * Math.tan(ang);
        
        // Calcul ViewBox intelligent
        // Largeur = Fond (0.5) + Shift + Geo + Marge
        const wM = 0.5 + shift + maxGeo + 1; 
        const hM = totH + hFondM + 1; // +1m de marge verticale pour textes

        const vbW = wM * S;
        const vbH = hM * S;
        
        // Marge haute (pour titre) et basse (pour semelle)
        const marginTop = 0.5 * S; 

        let svgC = `<svg width="100%" height="85%" viewBox="-${1*S} -${marginTop} ${vbW} ${vbH}" preserveAspectRatio="xMidYMid meet">
            <text x="${(shift+maxGeo)*S/2}" y="-10" text-anchor="middle" font-size="14" fill="#666" font-weight="bold">COUPE TECHNIQUE</text>
            <defs><pattern id="hatch" width="10" height="10" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><rect width="5" height="10" fill="#8d6e63"/></pattern></defs>`;

        for(let i=0; i<nbRangs; i++) {
            const p=profile[i]||{depth:50,geo:0};
            let d=0.30; if(state.product==='leromur') d=p.depth/100;
            const y = (nbRangs-1-i)*hBloc * S;
            const x = (i*hBloc*Math.tan(ang)) * S;
            svgC += `<rect x="${x}" y="${y}" width="${d*S}" height="${hBloc*S}" fill="#95a5a6" stroke="white" stroke-width="1"/>`;
            if(p.geo>0) svgC += `<line x1="${x+d*S}" y1="${y+hBloc*S}" x2="${x+d*S+p.geo*S}" y2="${y+hBloc*S}" stroke="#2980b9" stroke-width="4"/>`;
        }

        const yBot = nbRangs*hBloc*S;
        const wSem = (state.product==='leromur'&&profile[0] ? profile[0].depth/100 : 0.30) + 0.30;
        svgC += `<rect x="${-0.15*S}" y="${yBot}" width="${wSem*S}" height="${hFondM*S}" fill="#7f8c8d"/>`;
        svgC += `<text x="${-0.15*S}" y="${yBot+hFondM*S+15}" font-size="12" fill="#333">Semelle ${hFond}cm</text>`;
        
        const yTN = (totH-hBuried)*S;
        svgC += `<rect x="-50" y="${yTN}" width="${vbW+100}" height="${(hBuried+hFondM)*S+50}" fill="url(#hatch)" opacity="0.2"/>`;
        svgC += `<line x1="-50" y1="${yTN}" x2="${vbW}" y2="${yTN}" stroke="#8d6e63" stroke-width="2"/>`;
        svgC += `<text x="-40" y="${yTN-5}" font-size="12" fill="#8d6e63" font-weight="bold">TN (Fini)</text>`;
        
        svgC += `</svg>`;

        container.innerHTML = svgFace + svgC;
    }
    window.onload = () => { genererNappes(); updateUI(); };
</script>
</body>
</html>