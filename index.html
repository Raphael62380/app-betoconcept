<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur BÃ©toconcept V30 (Tarifs 2026)</title>
    
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzI3YWU2MCIgcng9IjIwIi8+PHBhdGggZD0iTTIwIDcwIEwyMCAzMCBMODAgMzAgTDgwIDcwIFoiIGZpbGw9IndoaXRlIi8+PHJlY3QgeD0iMzAiIHk9IjQwIiB3aWR0aD0iNDAiIGhlaWdodD0iMjAiIGZpbGw9IiMyN2FlNjAiLz48L3N2Zz4=">

    <style>
        :root {
            --primary: #27ae60;
            --secondary: #2c3e50;
            --accent: #e67e22;
            --info: #2980b9;
            --bg: #f0f2f5;
            --panel: #ffffff;
        }
        
        /* CORRECTION 1: Suppression du overflow hidden et height 100vh fixe */
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: var(--secondary); 
            font-size: 13px; 
            min-height: 100vh; /* Utilise au moins toute la hauteur */
            overflow-y: auto;  /* Autorise le scroll vertical */
        }

        /* Adaptation de la grille pour Ãªtre flexible */
        .app-grid { 
            display: grid; 
            grid-template-columns: 390px 1fr 340px; 
            gap: 15px; 
            padding: 15px; 
            box-sizing: border-box; 
            align-items: start; /* Les panneaux ne s'Ã©tirent pas forcÃ©ment en hauteur */
            min-height: 100vh;
        }

        .panel { 
            background: var(--panel); 
            border-radius: 8px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            /* On enlÃ¨ve overflow-y auto ici pour laisser la page scroller globalement */
            height: auto; 
        }
        
        /* HEADER */
        .app-header { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; background: #fafafa; border-radius: 6px; padding-top: 10px; }
        #logo-img { height: 70px; width: auto; margin-right: 15px; max-width: 200px; object-fit: contain; }
        .app-title { display: flex; flex-direction: column; justify-content: center; }
        .app-title h1 { margin: 0; font-size: 1.4em; color: var(--secondary); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1; }
        .app-title span { font-size: 0.85em; color: var(--primary); font-weight: 600; margin-top: 3px; }

        h2 { font-size: 1.1em; border-bottom: 2px solid var(--primary); padding-bottom: 8px; margin: 0 0 15px 0; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }
        h3 { font-size: 0.95em; color: #7f8c8d; margin: 15px 0 8px 0; font-weight: 600; text-transform: uppercase; border-top: 1px solid #eee; padding-top: 10px; }
        
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.9em; }
        input, select { width: 100%; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        
        .btn-group { display: flex; border: 1px solid #bdc3c7; border-radius: 4px; overflow: hidden; margin-bottom: 15px; flex-shrink: 0; }
        .btn-mode { flex: 1; padding: 8px; border: none; background: #f8f9fa; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: 0.2s; }
        .btn-mode.active { background: var(--secondary); color: white; }
        .color-switch { display: flex; gap: 10px; margin-bottom: 10px; background: #f8f9fa; padding: 5px; border-radius: 4px; flex-shrink: 0; }
        .radio-label { flex: 1; text-align: center; cursor: pointer; padding: 5px; border-radius: 4px; font-size: 0.9em; }
        .radio-label input { display: none; }
        .radio-label.checked { background: var(--accent); color: white; font-weight: bold; }
        .shape-switch { display: flex; gap: 5px; margin-bottom: 15px; background: #e8f5e9; padding: 5px; border-radius: 4px; }
        .shape-btn { flex: 1; border: 1px solid var(--primary); color: var(--primary); background: white; padding: 5px; border-radius: 4px; cursor: pointer; text-align: center; font-weight: bold; }
        .shape-btn.active { background: var(--primary); color: white; }

        .nappe-list { border: 1px solid #eee; background: #fafafa; border-radius: 4px; padding: 5px; overflow-y: visible; margin-bottom: 20px; }
        .nappe-row { display: grid; grid-template-columns: 70px 90px 1fr; align-items: center; gap: 8px; padding: 4px; border-bottom: 1px solid #eee; }
        .depth-select { padding: 4px; font-size: 0.85em; background: white; border: 1px solid #ccc; }
        .nappe-input { width: 100%; text-align: right; padding: 4px; }
        
        #visu-container { flex-grow: 1; min-height: 400px; border: 1px dashed #bdc3c7; border-radius: 4px; background: white; position: relative; }
        
        .res-block { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--secondary); }
        .res-block.logistique { background: #eaf2f8; border-left-color: var(--info); }
        .res-line { display: flex; justify-content: space-between; font-size: 0.95em; margin-bottom: 3px; }
        .res-total { font-size: 1.2em; font-weight: bold; color: var(--primary); text-align: right; margin-top: 5px; border-top: 1px solid #ddd; padding-top: 5px; }
        .price-input { width: 65px; text-align: right; background: white; border: 1px solid #ddd; height: 24px; padding: 2px 5px; }
        .log-full-pallet { margin-top: 6px; padding-top: 6px; border-top: 1px dashed #b8c6d1; font-size: 0.9em; color: #2c3e50; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 4px; }

        .remise-input { 
            width: 50px !important; 
            text-align: center; 
            border: 1px solid var(--accent) !important; 
            color: var(--accent); 
            font-weight: bold;
        }

        @media print {
            body { height: auto; overflow: visible; font-size: 12px; background: white; }
            .app-grid { display: block; padding: 0; min-height: 0; }
            .panel { margin-bottom: 20px; box-shadow: none; border: 1px solid #ddd; height: auto; overflow: visible; page-break-inside: avoid; }
            .btn-group, .no-print { display: none; }
            input, select { border: none; background: transparent; padding: 0; appearance: none; }
            #visu-container { height: 600px; border: 1px solid #000; }
            .res-block.logistique { background: #fff; border: 1px solid #ccc; }
            .remise-input { border: 1px solid #ccc !important; }
        }
        @media (max-width: 1000px) { body { overflow: auto; height: auto; } .app-grid { display: block; height: auto; } .panel { margin-bottom: 20px; height: auto; } }
    </style>
</head>
<body>

<div class="app-grid">
    <div class="panel">
        
        <div class="app-header">
            <img id="logo-img" src="logo.png" alt="BÃ©toconcept" onerror="this.style.display='none'">
            <div class="app-title">
                <h1>BÃ©toconcept</h1>
                <span>Calculateur Technique</span>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-mode active" onclick="setTarif('negoce', this)">NÃ©goce</button>
            <button class="btn-mode" onclick="setTarif('entreprise', this)">Entreprise</button>
            <button class="btn-mode" onclick="setTarif('particulier', this)">Particulier</button>
        </div>

        <div class="form-group">
            <label>Affaire / Client</label>
            <input type="text" id="client" placeholder="RÃ©fÃ©rence chantier...">
        </div>

        <h3>Forme du Mur</h3>
        <div class="shape-switch">
            <div class="shape-btn active" id="btn-rect" onclick="setShape('rect')">Mur Droit</div>
            <div class="shape-btn" id="btn-trap" onclick="setShape('trap')">Mur TrapÃ¨ze</div>
        </div>

        <h3>Produit & ParamÃ¨tres</h3>
        <div class="form-group">
            <label>Type de bloc</label>
            <select id="produit" onchange="updateUI()">
                <option value="leromur">LEROMUR (SÃ©cable H=13cm)</option>
                <option value="betoatlas">BETOATLAS (Bloc H=20cm)</option>
            </select>
        </div>

        <div class="form-group">
            <label>Inclinaison / Fruit (Â°)</label>
            <input type="number" id="inclinaison" value="0" min="0" max="45" step="1" oninput="calculer()" placeholder="Ex: 5">
        </div>

        <div class="color-switch">
            <label class="radio-label checked" onclick="setColor('gris', this)">
                <input type="radio" name="color" checked> Gris
            </label>
            <label class="radio-label" onclick="setColor('couleur', this)">
                <input type="radio" name="color"> Couleur
            </label>
        </div>

        <div class="form-group">
            <label>Longueur Totale (m)</label>
            <input type="number" id="longueur" value="10" oninput="calculer()">
        </div>

        <div class="form-group" style="display:flex; gap:10px">
            <div style="flex:1">
                <label id="lbl-h-gauche">Hauteur (m)</label>
                <input type="number" id="hauteur" value="2.00" min="0" step="0.01" onchange="genererNappes()">
            </div>
            <div style="flex:1; display:none;" id="col-h-droite">
                <label>Hauteur Droite (m)</label>
                <input type="number" id="hauteur-droite" value="1.00" min="0" step="0.01" onchange="genererNappes()">
            </div>
        </div>
        <div id="hauteur-info" style="font-size:0.85em; color:var(--info); margin-bottom:10px; font-style:italic;"></div>

        <h3>Coupe de Principe (Max)</h3>
        <div style="font-size:0.8em; color:#666; margin-bottom:5px; display:flex; justify-content:space-between; padding:0 5px;">
            <span>Rang</span>
            <span id="col-depth-title">Profondeur</span>
            <span>Nappe (m)</span>
        </div>
        
        <div id="nappes-container" class="nappe-list"></div>
        
        <div class="form-group">
            <label>Type de GÃ©otextile</label>
            <select id="typeGeo" onchange="updatePrixGeo()">
                <option value="50">BÃ©tonap 50/50</option>
                <option value="100" selected>BÃ©tonap 100/50</option>
                <option value="150">BÃ©tonap 150/50</option>
                <option value="200">BÃ©tonap 200/50</option>
            </select>
        </div>
    </div>

    <div class="panel">
        <h2>2. Vue de Face & Coupe</h2>
        <div id="visu-container"></div>
        <div style="text-align:center; font-size:0.8em; color:#999; margin-top:5px;">
            Le visuel de coupe prend en compte l'inclinaison.
        </div>
    </div>

    <div class="panel">
        <h2>3. Chiffrage & Logistique</h2>
        
        <div class="res-block">
            <div class="res-line"><span>Surface Mur (RÃ©elle) :</span> <strong id="res-surf">0.00 mÂ²</strong></div>
            <div class="res-line"><span id="lbl-qty">QuantitÃ© Ã  facturer :</span> <strong id="res-qty">0</strong></div>
            <div class="res-line"><span>Total GÃ©otextile :</span> <strong id="res-geo-total">0.00 mÂ²</strong></div>
        </div>

        <div class="res-block logistique">
            <div style="font-weight:bold; color:var(--info); margin-bottom:5px; font-size:0.9em; text-transform:uppercase;">ðŸ“¦ Logistique</div>
            <div class="res-line"><span id="log-label-produit">Besoin exact :</span></div>
            <div style="font-size:0.9em; color:#333; margin-bottom:5px; text-align:right; font-weight:bold;">
                <span id="log-detail-palettes">0 pal. + 0 u</span>
            </div>
            <div class="log-full-pallet">
                <div style="font-size:0.85em; font-weight:bold; margin-bottom:2px;">Option Palettes ComplÃ¨tes :</div>
                <div style="display:flex; justify-content:space-between;">
                    <span><span id="log-pal-sup">0</span> Palettes</span>
                    <strong>Soit <span id="log-items-sup">0</span> unitÃ©s</strong>
                </div>
            </div>
            <div class="log-full-pallet">
                <div style="font-size:0.85em; font-weight:bold; margin-bottom:2px;">Besoin GÃ©otextile (L=5.30m) :</div>
                <div class="res-line"><span>MÃ©trÃ© total :</span> <strong id="log-ml">0 ml</strong></div>
                <div style="text-align:right; font-size:0.9em; color:#2c3e50; font-weight:bold; margin-top:2px;">
                    <span id="log-detail-rouleaux">0 rlxs + 0 ml</span>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Forfait Ã‰tude (â‚¬ HT)</label>
            <input type="number" id="cout-etude" value="0" oninput="calculer()">
        </div>

        <h3>Tarifs HT DÃ©part (Remisables)</h3>
        
        <div class="res-line"><span>P.U. Ã‰lÃ©ment :</span> <input class="price-input" id="pu-bloc" type="number" step="0.01" onchange="calculer()"> â‚¬</div>
        <div class="res-line"><span>P.U. GÃ©o /mÂ² :</span> <input class="price-input" id="pu-geo" type="number" step="0.01" onchange="calculer()"> â‚¬</div>
        
        <hr>

        <div class="res-line" style="margin-top:10px; color:var(--accent);">
            <span style="font-weight:bold;">Remise Blocs :</span>
            <span><input type="number" id="remise-bloc" class="remise-input" value="0" min="0" max="100" oninput="calculer()"> %</span>
        </div>
        <div class="res-line" style="color:var(--accent);">
            <span style="font-weight:bold;">Remise GÃ©o :</span>
            <span><input type="number" id="remise-geo" class="remise-input" value="0" min="0" max="100" oninput="calculer()"> %</span>
        </div>

        <hr>
        
        <div class="res-line"><span>Total Ã‰lÃ©ments (Net) :</span> <span id="tot-blocs">0.00 â‚¬</span></div>
        <div class="res-line"><span>Total GÃ©o (Net) :</span> <span id="tot-geo">0.00 â‚¬</span></div>
        <div class="res-line"><span>Ã‰tude :</span> <span id="tot-etude">0.00 â‚¬</span></div>
        <div class="res-total">TOTAL HT NET : <span id="grand-total">0.00 â‚¬</span></div>
        <div style="text-align:right; font-size:0.85em; color:var(--primary); margin-top:5px;">Soit <strong id="px-m2">0.00</strong> â‚¬ HT / mÂ²</div>

        <button class="no-print" onclick="window.print()" style="margin-top:auto; background:var(--primary); color:white; border:none; padding:12px; border-radius:4px; font-weight:bold; cursor:pointer;">IMPRIMER L'OFFRE</button>
    </div>
</div>

<script>
    // === CONSTANTES ===
    const CONSTANTS = { 
        LEROMUR_BLOCS_M2: 38.5, 
        LEROMUR_H: 0.13, 
        BETOATLAS_H: 0.20, 
        BETOATLAS_BLOCS_M2: 20, 
        RECOUVREMENT: 0.40, 
        RECOUVREMENT_LATERAL: 0.20,
        PALETTE_LERO: 24, 
        PALETTE_BETO: 48, 
        LARGEUR_ROULEAU: 5.30,
        LONGUEUR_ROULEAU: 100
    };
    
    const DATA = { leromur: { h: CONSTANTS.LEROMUR_H, prices: { gris: [5.98, 6.70, 7.24], couleur: [7.37, 8.25, 8.91] } }, betoatlas: { h: CONSTANTS.BETOATLAS_H, prices: { gris: [3.99, 4.47, 4.83], couleur: [4.63, 5.19, 5.61] } } };
    const GEO_PRICES = { "50": [3.88, 4.35, 4.70], "100": [4.68, 5.24, 5.66], "150": [5.53, 6.19, 6.69], "200": [6.57, 7.36, 7.95] };
    let state = { mode: 0, color: 'gris', product: 'leromur', shape: 'rect' };

    // === FONCTIONS ===
    function setTarif(type, btn) {
        const map = { 'negoce': 0, 'entreprise': 1, 'particulier': 2 }; state.mode = map[type];
        document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active')); btn.classList.add('active');
        refreshPrices(); calculer();
    }
    function setColor(col, lbl) {
        state.color = col; document.querySelectorAll('.radio-label').forEach(l => l.classList.remove('checked')); lbl.classList.add('checked');
        refreshPrices(); calculer();
    }
    function setShape(shape) {
        state.shape = shape;
        document.getElementById('btn-rect').className = (shape==='rect' ? 'shape-btn active' : 'shape-btn');
        document.getElementById('btn-trap').className = (shape==='trap' ? 'shape-btn active' : 'shape-btn');
        updateUI();
    }
    function updateUI() {
        state.product = document.getElementById('produit').value; const isLeromur = (state.product === 'leromur');
        document.getElementById('lbl-qty').innerText = isLeromur ? 'Total Barres (1m) :' : 'Total Blocs :';
        document.getElementById('col-depth-title').style.visibility = isLeromur ? 'visible' : 'hidden';
        document.getElementById('log-label-produit').innerText = isLeromur ? 'Besoin exact (' + CONSTANTS.PALETTE_LERO + 'u/pal) :' : 'Besoin exact (' + CONSTANTS.PALETTE_BETO + 'u/pal) :';
        if(state.shape === 'trap') { document.getElementById('col-h-droite').style.display = 'block'; document.getElementById('lbl-h-gauche').innerText = 'Hauteur Gauche (m)'; } 
        else { document.getElementById('col-h-droite').style.display = 'none'; document.getElementById('lbl-h-gauche').innerText = 'Hauteur (m)'; }
        genererNappes();
    }
    function refreshPrices() {
        const pData = DATA[state.product]; const price = pData.prices[state.color][state.mode];
        document.getElementById('pu-bloc').value = price.toFixed(2); updatePrixGeo();
    }
    function updatePrixGeo() {
        const type = document.getElementById('typeGeo').value; const price = GEO_PRICES[type][state.mode];
        document.getElementById('pu-geo').value = price.toFixed(2); calculer();
    }
    function genererNappes() {
        const hG = parseFloat(document.getElementById('hauteur').value) || 0;
        let maxH = hG;
        if(state.shape === 'trap') { const hD = parseFloat(document.getElementById('hauteur-droite').value) || 0; maxH = Math.max(hG, hD); }
        const hElem = DATA[state.product].h;
        let nbRangs = (maxH > 0) ? Math.ceil(maxH / hElem) : 0;
        const infoDiv = document.getElementById('hauteur-info');
        if (state.shape === 'rect') infoDiv.innerHTML = `â†’ Hauteur rÃ©elle : <strong>${(nbRangs*hElem).toFixed(2)} m</strong> (${nbRangs} rangs)`;
        else infoDiv.innerHTML = `â†’ DÃ©finissez la coupe pour le point le plus haut (${(nbRangs*hElem).toFixed(2)} m)`;
        const container = document.getElementById('nappes-container');
        const oldRows = Array.from(container.querySelectorAll('.nappe-row'));
        container.innerHTML = '';
        for(let i=0; i<nbRangs; i++) {
            const div = document.createElement('div'); div.className = 'nappe-row';
            let oldGeo = 0; let oldDepth = "50"; 
            if (i < oldRows.length) {
                const inp = oldRows[i].querySelector('.inp-nappe'); if(inp) oldGeo = inp.value;
                const dSelect = oldRows[i].querySelector('.depth-select'); if(dSelect) oldDepth = dSelect.value;
            }
            let depthSelectorHTML = (state.product === 'leromur') ? `
                <select class="depth-select" onchange="calculer()">
                    <option value="25" ${oldDepth=="25"?'selected':''}>25 cm</option>
                    <option value="50" ${oldDepth=="50"?'selected':''}>50 cm</option>
                    <option value="75" ${oldDepth=="75"?'selected':''}>75 cm</option>
                    <option value="100" ${oldDepth=="100"?'selected':''}>100 cm</option>
                </select>` : `<span style="font-size:0.8em; color:#ccc;">Std</span>`;
            div.innerHTML = `<label>Rang ${i+1}</label>${depthSelectorHTML}<input type="number" class="inp-nappe" step="0.5" placeholder="0" value="${oldGeo > 0 ? oldGeo : ''}" oninput="calculer()">`;
            container.appendChild(div);
        }
        refreshPrices();
    }
    function calculer() {
        const L = parseFloat(document.getElementById('longueur').value) || 0;
        const hElem = DATA[state.product].h;
        const hG_input = parseFloat(document.getElementById('hauteur').value) || 0;
        const rows = Array.from(document.querySelectorAll('.nappe-row'));
        if(rows.length === 0 && hG_input > 0) return; 
        const masterProfile = rows.map(r => {
            let d = 50;
            if(state.product === 'leromur') { const sel = r.querySelector('.depth-select'); if(sel) d = parseInt(sel.value); }
            const inp = r.querySelector('.inp-nappe'); const g = (inp) ? parseFloat(inp.value) || 0 : 0;
            return { depth: d, geo: g };
        });
        let totalQty = 0; let totalSurface = 0; let totalGeoSurf = 0;
        
        if (state.shape === 'rect') {
            const nbRangs = rows.length; totalSurface = L * (nbRangs * hElem);
            masterProfile.forEach(p => {
                if(state.product === 'leromur') {
                    const blocsParMle = CONSTANTS.LEROMUR_H * CONSTANTS.LEROMUR_BLOCS_M2; 
                    let diviseur = 1; if(p.depth === 25) diviseur = 4; else if(p.depth === 50) diviseur = 2;
                    totalQty += (L * blocsParMle) / diviseur;
                } else { totalQty += (L * CONSTANTS.BETOATLAS_H * CONSTANTS.BETOATLAS_BLOCS_M2); }
                if(p.geo > 0) totalGeoSurf += (p.geo + CONSTANTS.RECOUVREMENT) * L;
            });
        } else {
            const hD_input = parseFloat(document.getElementById('hauteur-droite').value) || 0;
            const step = 0.1; const steps = Math.ceil(L / step); const totalMasterRows = masterProfile.length;
            if(steps > 0) {
                for(let i=0; i<steps; i++) {
                    const x = (i * step) + (step/2); const hLocal = hG_input + (hD_input - hG_input) * (x / L); const nbRangsLocal = Math.ceil(hLocal / hElem);
                    totalSurface += (step * nbRangsLocal * hElem);
                    const startIndex = totalMasterRows - nbRangsLocal;
                    for(let r=0; r<nbRangsLocal; r++) {
                        const masterIndex = startIndex + r;
                        if(masterIndex >= 0 && masterIndex < totalMasterRows) {
                            const p = masterProfile[masterIndex];
                            if(state.product === 'leromur') {
                                const blocsUnit = (step * CONSTANTS.LEROMUR_H * CONSTANTS.LEROMUR_BLOCS_M2);
                                let div = 1; if(p.depth === 25) div = 4; else if(p.depth === 50) div = 2;
                                totalQty += (blocsUnit / div);
                            } else { totalQty += (step * CONSTANTS.BETOATLAS_H * CONSTANTS.BETOATLAS_BLOCS_M2); }
                            if(p.geo > 0) totalGeoSurf += (p.geo + CONSTANTS.RECOUVREMENT) * step;
                        }
                    }
                }
            }
        }
        
        const coeffRecouvrementLateral = CONSTANTS.LARGEUR_ROULEAU / (CONSTANTS.LARGEUR_ROULEAU - 2 * CONSTANTS.RECOUVREMENT_LATERAL);
        const totalGeoSurfReelle = totalGeoSurf * coeffRecouvrementLateral;

        const quantiteAchat = Math.ceil(totalQty);
        let colisage = (state.product === 'leromur') ? CONSTANTS.PALETTE_LERO : CONSTANTS.PALETTE_BETO;
        let nbPalettes = (quantiteAchat > 0) ? quantiteAchat / colisage : 0;
        let palettesPleines = Math.floor(nbPalettes); let resteUnites = quantiteAchat % colisage;
        let palSup = Math.ceil(quantiteAchat / colisage); let itemsSup = palSup * colisage;
        
        const mlRouleau = Math.ceil(totalGeoSurfReelle / CONSTANTS.LARGEUR_ROULEAU);
        const nbRouleauxComplets = Math.floor(mlRouleau / CONSTANTS.LONGUEUR_ROULEAU);
        const resteMlRouleau = mlRouleau % CONSTANTS.LONGUEUR_ROULEAU;
        
        const puBloc = parseFloat(document.getElementById('pu-bloc').value) || 0;
        const puGeo = parseFloat(document.getElementById('pu-geo').value) || 0;
        const etude = parseFloat(document.getElementById('cout-etude').value) || 0;
        
        const remiseBlocPct = parseFloat(document.getElementById('remise-bloc').value) || 0;
        const remiseGeoPct = parseFloat(document.getElementById('remise-geo').value) || 0;

        let totBloc = quantiteAchat * puBloc;
        let totGeo = totalGeoSurfReelle * puGeo;
        
        totBloc = totBloc * (1 - (remiseBlocPct/100));
        totGeo = totGeo * (1 - (remiseGeoPct/100));

        const grandTotal = totBloc + totGeo + etude;
        
        document.getElementById('res-surf').innerText = totalSurface.toFixed(2) + " mÂ²";
        document.getElementById('res-qty').innerText = quantiteAchat;
        document.getElementById('log-detail-palettes').innerText = `${palettesPleines} pal. + ${resteUnites} u`;
        document.getElementById('log-pal-sup').innerText = palSup;
        document.getElementById('log-items-sup').innerText = itemsSup;
        
        document.getElementById('log-ml').innerText = mlRouleau + " ml";
        let detailRlxText = "";
        if(nbRouleauxComplets > 0) {
            detailRlxText = `${nbRouleauxComplets} rlxs de 100m + ${resteMlRouleau} ml`;
        } else {
            detailRlxText = `1 rlx (Coupe de ${resteMlRouleau} ml)`;
        }
        document.getElementById('log-detail-rouleaux').innerText = detailRlxText;

        document.getElementById('res-geo-total').innerText = totalGeoSurfReelle.toFixed(2) + " mÂ²";
        document.getElementById('tot-blocs').innerText = totBloc.toFixed(2) + " â‚¬";
        document.getElementById('tot-geo').innerText = totGeo.toFixed(2) + " â‚¬";
        document.getElementById('tot-etude').innerText = etude.toFixed(2) + " â‚¬";
        document.getElementById('grand-total').innerText = grandTotal.toFixed(2) + " â‚¬";
        document.getElementById('px-m2').innerText = (totalSurface > 0 ? grandTotal / totalSurface : 0).toFixed(2);
        
        if (rows.length > 0) drawDualVisu(rows.length, hElem, masterProfile);
        else document.getElementById('visu-container').innerHTML = '';
    }

    function drawDualVisu(nbRangs, hBloc, profile) {
        const container = document.getElementById('visu-container');
        const hG = parseFloat(document.getElementById('hauteur').value) || 0;
        const hD = (state.shape === 'trap') ? (parseFloat(document.getElementById('hauteur-droite').value)||0) : hG;
        const L = parseFloat(document.getElementById('longueur').value) || 10;
        
        // RECUPERATION DE L'ANGLE
        const angleDeg = parseFloat(document.getElementById('inclinaison').value) || 0;
        const angleRad = angleDeg * (Math.PI / 180);

        let svgFace = `<svg width="100%" height="100%" viewBox="-10 -20 120 120" preserveAspectRatio="xMidYMid meet">`;
        svgFace += `<text x="50" y="-5" text-anchor="middle" font-size="8" fill="#666">Vue de Face (Pente)</text>`;
        svgFace += `<line x1="0" y1="100" x2="100" y2="100" stroke="#7f8c8d" stroke-width="1"/>`;
        const scaleY = 80 / Math.max(hG, hD, 0.1); const yG = 100 - (hG * scaleY); const yD = 100 - (hD * scaleY);
        svgFace += `<polygon points="0,100 100,100 100,${yD} 0,${yG}" fill="#bdc3c7" stroke="#2c3e50" stroke-width="1"/>`;
        svgFace += `<text x="-5" y="${yG}" font-size="6">${hG}m</text>`;
        svgFace += `<text x="105" y="${yD}" font-size="6">${hD}m</text>`;
        svgFace += `<text x="50" y="110" font-size="6" text-anchor="middle">L=${L}m</text>`;
        svgFace += `</svg>`;

        let maxGeo = 0; if(profile && profile.length > 0) maxGeo = Math.max(2, ...profile.map(p=>p.geo)); else maxGeo = 2;
        
        // Calcul pour agrandir la vue si le mur penche beaucoup
        const maxShift = (nbRangs * hBloc) * Math.tan(angleRad);
        
        const scX = 100 / (maxGeo + maxShift/2); // Ajustement Ã©chelle X
        const totalH = nbRangs * hBloc; 
        const scY = 120 / (totalH || 1); 
        
        // ViewBox ajustÃ©e pour accepter le dÃ©calage Ã  droite (pente)
        let svgCoupe = `<svg width="100%" height="100%" viewBox="-20 -20 180 150" preserveAspectRatio="xMidYMid meet">`;
        svgCoupe += `<text x="50" y="-10" text-anchor="middle" font-size="8" fill="#666">Coupe Technique (${angleDeg}Â°)</text>`;
        
        // Ligne de sol
        svgCoupe += `<path d="M-10,${totalH*scY} L160,${totalH*scY}" stroke="#7f8c8d" stroke-width="2"/>`;
        
        for(let i=0; i<nbRangs; i++) {
            const p = profile[i] || {depth:50, geo:0};
            // Calcul coordonnÃ©es
            const y = (nbRangs - 1 - i) * hBloc * scY; 
            const hPx = hBloc * scY; 
            const wPx = (p.depth / 100) * 20; 
            
            // Calcul du dÃ©calage horizontal dÃ» au fruit (angle)
            // Rang 0 (bas) = pas de dÃ©calage. Rang i (haut) = dÃ©calage.
            const shiftMeters = (i * hBloc) * Math.tan(angleRad);
            const shiftPx = shiftMeters * scX; // Conversion approximative pour le visuel

            // Dessin Bloc
            svgCoupe += `<rect x="${shiftPx}" y="${y}" width="${Math.max(5, wPx)}" height="${hPx}" fill="#95a5a6" stroke="white" stroke-width="0.5"/>`;
            
            // Dessin Geo
            if(p.geo > 0) {
                const lenPx = p.geo * scX;
                svgCoupe += `<line x1="${shiftPx+2}" y1="${y}" x2="${shiftPx+2+lenPx}" y2="${y}" stroke="#2980b9" stroke-width="2"/>`;
            }
        }
        
        // Ligne pointillÃ©e reprÃ©sentant le fruit arriÃ¨re thÃ©orique
        if(angleDeg > 0) {
             const topShiftPx = (nbRangs * hBloc * Math.tan(angleRad)) * scX;
             svgCoupe += `<line x1="0" y1="${totalH*scY}" x2="${topShiftPx}" y2="0" stroke="red" stroke-width="0.5" stroke-dasharray="2,2" opacity="0.5"/>`;
        }

        svgCoupe += `</svg>`;

        container.innerHTML = `
            <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                <div style="flex: 0 0 15%; border-bottom:1px dashed #eee; margin-bottom:5px; min-height:80px;">${svgFace}</div>
                <div style="flex: 1; min-height:0; position:relative;">${svgCoupe}</div>
            </div>`;
    }
    window.onload = () => { genererNappes(); updateUI(); };
</script>
</body>
</html>